<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{client/layout}">
<head>
<title th:text="${breadcrumb} + ' - IVY moda'"></title>
</head>
<body>
	<div layout:fragment="content">
		<div class="container-ivy"
			style="margin-top: 30px; margin-bottom: 80px;">

			<div class="mb-4 text-uppercase font-weight-bold"
				style="font-size: 14px;">
				<a th:href="@{/}" class="text-dark">Trang chủ</a> <span class="mx-2">-</span>
				<span th:text="${breadcrumb}">DANH MỤC</span>
			</div>

			<div class="row">
				<div class="col-lg-3 d-none d-lg-block pr-5">

                    <form id="filterForm"
						th:action="${keyword != null} ? @{/search} : @{'/danh-muc/' + ${currentSlug}}"
						method="get">
                        
                        <input th:if="${keyword != null}" type="hidden" name="keyword" th:value="${keyword}">

<div class="filter-group">
    <div class="filter-header">
        <span>Size</span> <i class="fas fa-plus"></i>
    </div>
    <div class="filter-content">
        <div class="filter-size-list">
            
            <div th:each="s : ${ {'S','M','L','XL','XXL'} }" class="size-item-wrapper">
                
                <input type="checkbox" class="size-checkbox-hidden"
                    th:id="'size-'+${s}" name="size" th:value="${s}"
                    th:checked="${selectedSizes != null && #lists.contains(selectedSizes, s)}">
                
                <label class="size-swatch" th:for="'size-'+${s}" th:text="${s}">
                    S
                </label>
            </div>
        </div>
    </div>
</div>

						<div class="filter-group">
    <div class="filter-header">
        <span>Màu sắc</span> <i class="fas fa-plus"></i>
    </div>
    <div class="filter-content">
        <div class="filter-color-list">
            
            <div th:each="c : ${ {'Đen','Trắng','Xanh dương','Vàng','Hồng','Đỏ','Xám','Be','Nâu','Xanh lá','Cam','Tím'} }" 
                 class="color-item-wrapper">
                
                <th:block th:with="bgCode=${
                    c == 'Đen' ? '#000000' : 
                    c == 'Trắng' ? '#FFFFFF' : 
                    c == 'Xanh dương' ? '#254a7e' : 
                    c == 'Vàng' ? '#e8d653' :
                    c == 'Hồng' ? '#f07da0' :
                    c == 'Đỏ' ? '#ff0000' :
                    c == 'Xám' ? '#696969' :
                    c == 'Be' ? '#e6dcc8' :
                    c == 'Nâu' ? '#6f4e37' :
                    c == 'Xanh lá' ? '#2e6b47' :
                    c == 'Cam' ? '#f28e2b' :
                    c == 'Tím' ? '#917fb0' : '#cccccc'
                }">

                    <input type="checkbox" class="color-checkbox-hidden"
                        th:id="'color-'+${c}" name="color" th:value="${c}"
                        th:checked="${selectedColors != null && #lists.contains(selectedColors, c)}">
                    
                    <label class="color-swatch" 
                           th:for="'color-'+${c}" 
                           th:style="'background-color: ' + ${bgCode}"
                           th:data-title="${c}"> </label>
                </th:block>
            </div>
        </div>
    </div>
</div>

						<div class="filter-group">
							<div class="filter-header">
								<span>Mức giá</span> <i class="fas fa-plus"></i>
							</div>

							<div class="filter-content px-2 pb-3" style="display: none;">

								<div id="price-slider" class="mt-3 mb-3"></div>

								<div class="price-values">
									<span id="price-min-display">0đ</span> <span
										id="price-max-display">10.000.000đ</span>
								</div>

                                <input type="hidden" name="minPrice" id="minPriceInput"
									th:value="${selectedMinPrice != null ? #numbers.formatDecimal(selectedMinPrice, 0, 'NONE', 0, 'POINT') : ''}">

								<input type="hidden" name="maxPrice" id="maxPriceInput"
									th:value="${selectedMaxPrice != null ? #numbers.formatDecimal(selectedMaxPrice, 0, 'NONE', 0, 'POINT') : ''}">
							</div>
						</div>

						<div class="filter-group">
							<div class="filter-header">
								<span>Mức chiết khấu</span> <i class="fas fa-plus"></i>
							</div>
							<div class="filter-content">
								<p class="small text-muted">Đang cập nhật...</p>
							</div>
						</div>

						<div class="filter-group">
							<div class="filter-header">
								<span>Nâng cao</span> <i class="fas fa-plus"></i>
							</div>
							<div class="filter-content">
								<p class="small text-muted">Đang cập nhật...</p>
							</div>
						</div>

						<div class="filter-actions mt-5 d-flex justify-content-between">

							<a th:href="${keyword != null} ? @{/search(keyword=${keyword})} : @{'/danh-muc/' + ${currentSlug}}"
								class="btn-filter-clear"> BỎ LỌC </a>

							<button type="submit" class="btn-filter-submit">LỌC</button>
						</div>

					</form>
				</div>

				<div class="col-lg-9 col-12">

					<h2 class="font-weight-bold mb-4" th:text="${breadcrumb}">TIÊU
						ĐỀ</h2>

					<div th:if="${not #lists.isEmpty(products)}">
						<div class="row">
							<div class="col-lg-3 col-6 mb-4" th:each="p : ${products}">
								<div
									th:replace="~{client/fragments/product-card :: product-item(p=${p})}"></div>
							</div>
						</div>

						<div class="d-flex justify-content-center mt-5"
							th:if="${totalPages > 1}">
							<nav>
								<ul class="pagination">
									<li class="page-item"
										th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
										th:classappend="${currentPage == i} ? 'active'">
                                        <a class="page-link text-dark font-weight-bold border-0 mx-1"
										th:href="${keyword != null} ? @{/search(keyword=${keyword}, page=${i})} 
                                  : @{'/danh-muc/' + ${currentSlug}(page=${i}, size=${selectedSizes}, minPrice=${selectedMinPrice}, maxPrice=${selectedMaxPrice})}"
										th:text="${i + 1}">1</a></li>
								</ul>
							</nav>
						</div>
					</div>

					<div th:if="${#lists.isEmpty(products)}" class="text-center py-5">
						<div class="mb-3">
							<i class="fas fa-search" style="font-size: 50px; color: #e1e1e1;"></i>
						</div>

						<h5 class="font-weight-bold text-muted mb-3">Không tìm thấy
							sản phẩm phù hợp</h5>
						<p class="text-muted small mb-4">Vui lòng thử lại với từ khóa
							khác hoặc điều chỉnh bộ lọc.</p>

						<a th:href="@{/}" class="btn btn-dark"
							style="border-radius: 20px 0 20px 0; padding: 10px 30px; font-weight: 600;">
							TIẾP TỤC MUA SẮM </a>
					</div>

				</div>
			</div>
		</div>
	</div>

	<th:block layout:fragment="pageScripts">
		<script>
			$(document).ready(function() {
                // 1. Code Accordion cũ của bạn (Giữ nguyên)
                $('.filter-header').click(function() {
                    $(this).next('.filter-content').slideToggle(300);
                    var icon = $(this).find('i');
                    if (icon.hasClass('fa-plus')) {
                        icon.removeClass('fa-plus').addClass('fa-minus');
                    } else {
                        icon.removeClass('fa-minus').addClass('fa-plus');
                    }
                });

                // 2. Tự động mở tab nếu có ô input đang được chọn
                $('.filter-content').each(function() {
                    if ($(this).find('input:checked').length > 0) {
                        $(this).show();
                        $(this).prev('.filter-header').find('i').removeClass('fa-plus').addClass('fa-minus');
                    }
                });

                // ==========================================
                // 3. CẤU HÌNH SLIDER (CODE ĐÃ UPDATE)
                // ==========================================
                var slider = document.getElementById('price-slider');

                if (slider) { 
                    var sliderLimit = 10000000; // Max 10 triệu

                    // Lấy giá trị từ Input (Rỗng -> Mặc định)
                    var inputMin = $('#minPriceInput').val();
                    var inputMax = $('#maxPriceInput').val();

                    var currentMin = inputMin ? parseInt(inputMin) : 0;
                    var currentMax = inputMax ? parseInt(inputMax) : sliderLimit;

                    // Nếu đang lọc giá (Có giá trị trong input), tự động mở tab
                    if (inputMin && (currentMin > 0 || currentMax < sliderLimit)) {
                        $('#minPriceInput').closest('.filter-content').show();
                        $('#minPriceInput').closest('.filter-group').find('.fa-plus').removeClass('fa-plus').addClass('fa-minus');
                    }

                    noUiSlider.create(slider, {
                        start : [ currentMin, currentMax ], 
                        connect : true, 
                        range : {
                            'min' : 0,
                            'max' : sliderLimit
                        },
                        step : 100000, 
                        format : {
                            to : function(value) { return Math.round(value); },
                            from : function(value) { return Number(value); }
                        }
                    });

                    slider.noUiSlider.on('update', function(values, handle) {
                        var value = values[handle];
                        // Format tiền tệ Việt Nam (dấu chấm)
                        var formattedValue = new Intl.NumberFormat('vi-VN').format(value) + 'đ';

                        if (handle === 0) {
                            $('#price-min-display').text(formattedValue);
                            $('#minPriceInput').val(value);
                        } else {
                            $('#price-max-display').text(formattedValue);
                            $('#maxPriceInput').val(value);
                        }
                    });
                }
            });
		</script>
	</th:block>
</body>
</html>