<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{client/layout}">
<head>
    <title th:text="${product.name} + ' - IVY moda'">Chi tiết sản phẩm</title>
    <style>
        /* CSS cho ô màu sắc */
        .color-option-box {
            width: 30px;
            height: 30px;
            border: 1px solid #ddd;
            border-radius: 50%; /* Tròn */
            cursor: pointer;
            display: inline-block;
            margin-right: 10px;
            position: relative;
        }
        /* Viền khi màu đang được chọn */
        .color-option-box.active-color {
            border: 2px solid #222; /* Viền đen đậm */
            transform: scale(1.1);
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        /* Gạch chéo cho size hết hàng */
        .size-box.disabled {
            background-color: #f8f9fa;
            color: #ccc;
            cursor: not-allowed;
            text-decoration: line-through;
            border-color: #eee;
        }
    </style>
</head>
<body>
    <div layout:fragment="content">

        <div class="container-ivy mb-3 mt-3">
            <small class="text-muted"> 
                <a th:href="@{/}" class="text-muted">Trang chủ</a> - 
                <span class="text-dark" th:text="${product.name}"></span>
            </small>
        </div>

        <div class="container-ivy">
            <div class="product-detail-row">

                <div>
                    <div th:if="${selectedColor != null}" class="gallery-wrapper">

                        <div class="gallery-main">
                            <img id="mainImage"
                                 th:if="${not #lists.isEmpty(selectedColor.images)}"
                                 th:src="@{'/uploads/' + ${selectedColor.images[0].imageUrl}}"
                                 class="main-img-display" alt="Ảnh chính">
                                 
                            <img id="mainImage"
                                 th:if="${#lists.isEmpty(selectedColor.images)}"
                                 src="https://via.placeholder.com/500x750?text=No+Image"
                                 class="main-img-display">
                        </div>

                        <div class="gallery-thumbs-container" th:if="${not #lists.isEmpty(selectedColor.images)}">
    <button class="thumb-arrow up"
            th:if="${selectedColor.images.size() > 4}" 
            onclick="scrollThumbs('up')">
        <i class="fas fa-chevron-up"></i>
    </button>

    <div class="gallery-thumbs-scroll" id="thumbScroller">
        <img th:each="img, iter : ${selectedColor.images}"
             th:src="@{'/uploads/' + ${img.imageUrl}}" class="thumb-img"
             th:classappend="${iter.index == 0} ? 'active'"
             th:onclick="'changeMainImage(this, \'' + @{'/uploads/' + ${img.imageUrl}} + '\')'">
    </div>

    <button class="thumb-arrow down"
            th:if="${selectedColor.images.size() > 4}"
            onclick="scrollThumbs('down')">
        <i class="fas fa-chevron-down"></i>
    </button>
</div>
                    </div>
                </div>

                <div class="product-info-col">
                    
                    <input type="hidden" name="productId" th:value="${product.id}">

                    <h2 class="font-weight-bold text-uppercase mb-2"
                        style="font-size: 24px;" th:text="${product.name}"></h2>

                    <div class="product-price-large"
                         th:text="${#numbers.formatDecimal(product.basePrice, 0, 'POINT', 0, 'COMMA')} + 'đ'">
                    </div>

                    <div class="mb-4 mt-3">
                        <div class="color-label mb-2">
                            Màu sắc: <span class="font-weight-bold"
                                           th:text="${selectedColor.color.name}">Trắng ngà</span>
                        </div>
                        <div class="d-flex flex-wrap">
                            <th:block th:each="pc : ${product.productColors}">
                                <a th:if="${pc.isActive}" 
                                   th:href="@{'/product/' + ${product.id} + '?color=' + ${pc.color.name}}"
                                   th:title="${pc.color.name}"
                                   style="text-decoration: none;">
                                    
                                    <span class="color-option-box"
                                          th:classappend="${pc.id == selectedColor.id} ? 'active-color'"
                                          th:style="'background-color:' + ${pc.color.hexCode}">
                                    </span>
                                </a>
                            </th:block>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="mb-4">
                            <div th:each="variant : ${selectedColor.variants}"
                                 class="size-box"
                                 th:classappend="${variant.stock <= 0} ? 'disabled'"
                                 th:onclick="${variant.stock > 0} ? 'selectSize(this)' : ''"
                                 th:title="${variant.stock <= 0} ? 'Hết hàng' : 'Còn ' + ${variant.stock}">
                                
                                <span th:text="${variant.size.name}">S</span>
                                
                                <input type="radio" name="variantId" th:value="${variant.id}" hidden>
                            </div>

                            <div id="size-error" class="text-danger mt-2"
                                 style="display: none; font-size: 13px;">
                                <i class="fas fa-exclamation-circle"></i> Vui lòng chọn kích cỡ (Size)
                            </div>
                            
                            <div th:if="${#lists.isEmpty(selectedColor.variants)}" class="text-danger mt-2 small">
                                Tạm hết hàng màu này.
                            </div>
                        </div>
                        
                        <div class="mt-2 text-muted small">
                            <i class="fas fa-ruler-combined mr-1"></i> Kiểm tra size của bạn
                        </div>
                    </div>

<div class="mb-4">
    <label class="font-weight-bold d-block mb-2">Số lượng</label>
    <div class="qty-control">
        <button type="button" class="qty-btn" onclick="updateQty(-1)">-</button>
        <input type="text" name="quantity" id="qtyInput" value="1" class="qty-input" readonly>
        <button type="button" class="qty-btn" onclick="updateQty(1)">+</button>
    </div>
</div>

<div class="action-buttons">
    <button type="button" onclick="addToCartFromDetail()" class="btn-add-cart-black">
        THÊM VÀO GIỎ
    </button>

    <button type="button" class="btn-buy-now-white" onclick="buyNow()">
        MUA HÀNG
    </button>

    <div class="btn-wishlist-box">
        <i class="far fa-heart"></i>
    </div>
</div>
                    
                    
                    
                    
    <div class="mt-5">
    <div class="single-tab-header">
        <span class="tab-title">CHI TIẾT SẢN PHẨM</span>
    </div>
    
    <div id="productDescription" class="product-desc-wrapper collapsed">
        <div class="text-muted product-desc-content" style="font-size: 14px; line-height: 1.8;">
            <p th:text="${product.description}" style="white-space: pre-line;"></p>
            
            </div>
    </div>

    <div class="text-center mt-3 toggle-container">
        <div class="toggle-line"></div>
        <button type="button" class="btn-toggle-desc" onclick="toggleDescription()">
            <i id="toggleIcon" class="fas fa-chevron-down"></i>
        </button>
    </div>
</div>

                </div>

            </div>
        </div>
    </div>

    <th:block layout:fragment="pageScripts">
        <script>
            // 1. Đổi ảnh chính
            function changeMainImage(thumbElement, newSrc) {
                document.getElementById('mainImage').src = newSrc;
                document.querySelectorAll('.thumb-img').forEach(el => el.classList.remove('active'));
                thumbElement.classList.add('active');
            }

            // 2. Cuộn Thumbnails
 function scrollThumbs(direction) {
    const container = document.getElementById('thumbScroller');
    const scrollAmount = 165; // Cuộn đúng chiều cao 1 ảnh + margin
    
    if (direction === 'up') {
        container.scrollTop -= scrollAmount;
    } else {
        container.scrollTop += scrollAmount;
    }
}

            // 3. Chọn Size
            function selectSize(element) {
                // Nếu bị disabled (hết hàng) thì không làm gì
                if (element.classList.contains('disabled')) return;

                document.querySelectorAll('.size-box').forEach(el => el.classList.remove('active'));
                element.classList.add('active');
                
                element.querySelector('input').checked = true;
                document.getElementById('size-error').style.display = 'none';
            }

            // 4. Cập nhật Số lượng
            function updateQty(change) {
                const input = document.getElementById('qtyInput');
                let newVal = parseInt(input.value) + change;
                if (newVal < 1) newVal = 1;
                input.value = newVal;
            }
            
            
            function toggleDescription() {
                const wrapper = document.getElementById('productDescription');
                const icon = document.getElementById('toggleIcon');
                
                if (wrapper.classList.contains('collapsed')) {
                    // MỞ RỘNG
                    wrapper.classList.remove('collapsed');
                    // Cho phép chiều cao mở rộng tự động theo nội dung
                    wrapper.style.maxHeight = wrapper.scrollHeight + "px";
                    
                    // Đổi icon thành mũi tên lên
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                } else {
                    // THU GỌN
                    wrapper.classList.add('collapsed');
                    wrapper.style.maxHeight = "150px"; // Trở về chiều cao giới hạn ban đầu
                    
                    // Đổi icon thành mũi tên xuống
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                    
                    // Cuộn nhẹ lên đầu phần chi tiết để người dùng không bị lạc
                    wrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
            
            
        </script>
    </th:block>
</body>
</html>